google.charts.load("current", { packages: ["corechart"] });

var currentYear = new Date().getFullYear();

function renderCharts(chartType) {
    if (chartType === "year") {
        axios
            .get("/chart-data-anak")
            .then(function (response) {
                var chartData = response.data;

                google.charts.setOnLoadCallback(function () {
                    drawChartAnak(chartData);
                });
            })
            .catch(function (error) {
                console.error("Error fetching chart data:", error);
            });
    }
}

function drawChartAnak(chartData) {
    var data = google.visualization.arrayToDataTable(chartData.data);

    var options = {
        title: chartData.title,
        subtitle: "Tahun " + currentYear,
        width: "100%",
        height: 300,
        legend: {
            position: "top",
        },
        chartArea: {
            left: 50,
            top: 50,
            width: "90%",
            height: 200,
        },
    };

    var screenWidth = window.innerWidth;

    // Check screen width for responsive display
    if (screenWidth > 768) {
        var columnChart = new google.visualization.ColumnChart(
            document.getElementById("column-chart-anak")
        );
        columnChart.draw(data, options);

        // Hide pie chart and show column chart
        document.getElementById("pie-chart-anak").style.display = "none";
        document.getElementById("column-chart-anak").style.display = "block";
    } else if (screenWidth <= 768 && screenWidth > 500) {
        var mediumPieOptions = {
            title: chartData.title,
            subtitle: "Tahun " + currentYear,
            width: "100%",
            height: 250,
            chartArea: {
                left: 50,
                top: 50,
                width: "90%",
                height: 150,
            },
            pieSliceText: 'none'
        };

        var mediumPieChart = new google.visualization.PieChart(
            document.getElementById("pie-chart-anak")
        );
        mediumPieChart.draw(data, mediumPieOptions);

        // Hide column chart and show pie chart for medium screens
        document.getElementById("column-chart-anak").style.display = "none";
        document.getElementById("pie-chart-anak").style.display = "block";
    } else if (screenWidth <= 500) {
        var smallPieOptions = {
            title: chartData.title,
            subtitle: "Tahun " + currentYear,
            width: "100%",
            height: 200,
            chartArea: {
                left: 50,
                top: 50,
                width: "90%",
                height: 100,
            },
            pieSliceText: 'none'
        };

        var smallPieChart = new google.visualization.PieChart(
            document.getElementById("pie-chart-anak")
        );
        smallPieChart.draw(data, smallPieOptions);

        // Hide column chart and show pie chart for small screens
        document.getElementById("column-chart-anak").style.display = "none";
        document.getElementById("pie-chart-anak").style.display = "block";
    } else {
        // Default: Jika lebar layar antara 501px - 768px, gambar diagram lingkaran dengan ukuran medium
        var mediumPieOptions = {
            title: chartData.title,
            subtitle: "Tahun " + currentYear,
            width: "100%",
            height: 250, // Ukuran medium default untuk lebar layar 501px - 768px
            chartArea: {
                left: 50,
                top: 50,
                width: "90%",
                height: 150, // Ukuran medium default untuk lebar layar 501px - 768px
            },
            pieSliceText: 'none'
        };

        var mediumPieChart = new google.visualization.PieChart(
            document.getElementById("pie-chart-anak")
        ); // Gunakan ID pie-chart
        mediumPieChart.draw(data, mediumPieOptions);

        // Sembunyikan diagram batang
        document.getElementById("column-chart-anak").style.display = "none";
        // Tampilkan diagram lingkaran
        document.getElementById("pie-chart-anak").style.display = "block";
    }
}

function exportChartAnak(format) {
    var chartContainer = document.getElementById("chart-container-anak");

    // Sembunyikan dropdown saat melakukan export
    chartContainer.classList.add("hide-dropdown");

    // Menggunakan html2canvas untuk membuat screenshot chart
    html2canvas(chartContainer).then(function (canvas) {
        var imgData;
        var filename = "chart";

        if (format === "jpg") {
            imgData = canvas.toDataURL("image/jpeg");
            filename += ".jpg";
        } else if (format === "png") {
            imgData = canvas.toDataURL("image/png");
            filename += ".png";
        } else if (format === "pdf") {
            // Jika format PDF, menggunakan jspdf
            var pdf = new jsPDF();
            pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0);
            filename += ".pdf";
            pdf.save(filename);

            // Tampilkan kembali dropdown setelah export selesai
            chartContainer.classList.remove("hide-dropdown");

            return; // Keluar dari fungsi setelah menyimpan PDF
        } else {
            console.error("Invalid format specified for export.");
            // Tampilkan kembali dropdown setelah export gagal
            chartContainer.classList.remove("hide-dropdown");
            return; // Keluar dari fungsi jika format tidak valid
        }

        // Buat elemen <a> untuk men-download gambar
        var a = document.createElement("a");
        a.href = imgData;
        a.download = filename;
        document.body.appendChild(a); // Tambahkan elemen <a> ke dalam body
        a.click();
        document.body.removeChild(a); // Hapus elemen <a> setelah di-klik

        // Tampilkan kembali dropdown setelah export selesai
        chartContainer.classList.remove("hide-dropdown");
    });
}

google.charts.load("current", {
    packages: ["corechart"],
});

renderCharts("year");
