// Load Google Charts library
google.charts.load("current", { packages: ["corechart"] });

var currentYear = new Date().getFullYear();

// Function to render charts based on chartType
function renderCharts(chartType) {
    if (chartType === "year") {
        axios
            .get("/chart-data-pendukung")
            .then(function (response) {
                console.log("Response data:", response.data); // Log response data for inspection
                var chartData = response.data;
                google.charts.setOnLoadCallback(function () {
                    drawChartPendukung(chartData);
                });
            })
            .catch(function (error) {
                console.error("Error fetching chart data:", error);
            });
    }
}

// Function to draw chart using Google Charts
function drawChartPendukung(chartData) {
    console.log("Chart data:", chartData);
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Bulan');
    data.addColumn('number', 'Jumlah Donatur');
    data.addColumn('number', 'Jumlah Sponsor');

    // Add data from response to Google Charts data table
    for (var i = 0; i < chartData.labels.length; i++) {
        data.addRow([chartData.labels[i], chartData.datasets[0].data[i], chartData.datasets[1].data[i]]);
    }

    var options = {
        title: chartData.title,
        subtitle: "Tahun " + currentYear,
        width: "100%",
        height: 300,
        legend: { position: "top" },
        chartArea: { left: 50, top: 50, width: "90%", height: 200 }
    };

    var screenWidth = window.innerWidth;

    // Check screen width for responsive display
    if (screenWidth > 768) {
        var columnChart = new google.visualization.ColumnChart(
            document.getElementById("column-chart-pendukung")
        );
        columnChart.draw(data, options);

        // Hide pie chart and show column chart
        document.getElementById("pie-chart-pendukung").style.display = "none";
        document.getElementById("column-chart-pendukung").style.display = "block";
    } else if (screenWidth <= 768 && screenWidth > 500) {
        var mediumPieOptions = {
            title: chartData.title,
            subtitle: "Tahun " + currentYear,
            width: "100%",
            height: 250,
            chartArea: {
                left: 50,
                top: 50,
                width: "90%",
                height: 150,
            },
            pieSliceText: 'none'
        };

        var mediumPieChart = new google.visualization.PieChart(
            document.getElementById("pie-chart-pendukung")
        );
        mediumPieChart.draw(data, mediumPieOptions);

        // Hide column chart and show pie chart for medium screens
        document.getElementById("column-chart-pendukung").style.display = "none";
        document.getElementById("pie-chart-pendukung").style.display = "block";
    } else if (screenWidth <= 500) {
        var smallPieOptions = {
            title: chartData.title,
            subtitle: "Tahun " + currentYear,
            width: "100%",
            height: 200,
            chartArea: {
                left: 50,
                top: 50,
                width: "90%",
                height: 100,
            },
            pieSliceText: 'none'
        };

        var smallPieChart = new google.visualization.PieChart(
            document.getElementById("pie-chart-pendukung")
        );
        smallPieChart.draw(data, smallPieOptions);

        // Hide column chart and show pie chart for small screens
        document.getElementById("column-chart-pendukung").style.display = "none";
        document.getElementById("pie-chart-pendukung").style.display = "block";
    } else {
        // Draw pie chart as default for medium screens
        var mediumPieChart = new google.visualization.PieChart(
            document.getElementById("pie-chart-pendukung")
        );
        mediumPieChart.draw(data, mediumPieOptions);

        // Hide column chart and show pie chart for default case
        document.getElementById("column-chart-pendukung").style.display = "none";
        document.getElementById("pie-chart-pendukung").style.display = "block";
    }
}

// Function to export chart as JPG, PNG, or PDF
function exportChartPendukung(format) {
    var chartContainer = document.getElementById("chart-container-pendukung");
    chartContainer.classList.add("hide-dropdown");

    html2canvas(chartContainer).then(function (canvas) {
        var imgData;
        var filename = "chart";

        if (format === "jpg") {
            imgData = canvas.toDataURL("image/jpeg");
            filename += ".jpg";
        } else if (format === "png") {
            imgData = canvas.toDataURL("image/png");
            filename += ".png";
        } else if (format === "pdf") {
            var pdf = new jsPDF();
            pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0);
            filename += ".pdf";
            pdf.save(filename);
            chartContainer.classList.remove("hide-dropdown");
            return;
        } else {
            console.error("Invalid format specified for export.");
            chartContainer.classList.remove("hide-dropdown");
            return;
        }

        var a = document.createElement("a");
        a.href = imgData;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        chartContainer.classList.remove("hide-dropdown");
    });
}

// Callback function to render charts when Google Charts library is loaded
google.charts.setOnLoadCallback(function () {
    renderCharts("year");
});
